# Discord KPI 自動保存テスト計画

## 🎯 テスト目的
24時間自動収集機能が正常に動作することを確認する

## 📋 テスト手順

### Phase 1: 短時間テスト（推奨）

1. **テスト用コマンド追加**
   ```bash
   # metrics_collector.pyに2分間隔のテストループを追加
   # /metrics_auto_test start でテスト開始
   ```

2. **テスト実行**
   ```bash
   # Discordで実行
   /metrics_auto_test start
   
   # ログ監視開始
   tail -f C:\zeroone_support\bot.log
   ```

3. **確認ポイント**
   - 2分おきに「🧪 テスト用自動メトリクス収集開始...」が出力される
   - 「✅ テスト用自動保存成功」が表示される
   - データベースに新しいレコードが追加される

4. **テスト停止**
   ```bash
   /metrics_auto_test stop
   ```

### Phase 2: 本番確認

1. **現在の自動収集状態確認**
   ```bash
   # ログで最後の実行時刻を確認
   findstr "定期メトリクス" C:\zeroone_support\bot.log
   ```

2. **24時間後の確認**
   ```bash
   # 翌日同時刻にログとデータベースを確認
   cd /mnt/c/find-to-do-management-app
   npx tsx scripts/check-discord-metrics.ts
   ```

## 🔍 確認すべきログメッセージ

### 正常動作時
```
⏰ 定期メトリクス収集開始...
📊 KPI収集開始...
📍 対象サーバー: ZERO to ONE サポート (ID: 1236319711113777233)
👥 ロール イベント情報: 7人
👥 ロール みんなの告知: 4人
👥 ロール FIND TO DO: 100人
... (その他ロール)
👥 アクティブユーザー数（運営除く): X
📈 エンゲージメントスコア: X.XX
✅ メトリクス収集完了: 2025-06-14
📊 DB接続成功
SQL実行開始...
✅ データベース保存成功: INSERT 0 1
📝 メッセージカウントをリセットしました
✅ 定期メトリクス収集・保存完了
```

### エラー時
```
❌ 定期メトリクス保存失敗
❌ データベース保存エラー: [エラー詳細]
❌ メトリクス収集エラー: [エラー詳細]
```

## 🚨 トラブルシューティング

### よくある問題

1. **「❌ サーバーが見つかりません」**
   - ボット起動直後に発生する可能性
   - bot.wait_until_ready()が正常に動作しているか確認

2. **データベース接続エラー**
   - .envファイルのNEON_DATABASE_URLを確認
   - ネットワーク接続を確認

3. **「定期メトリクス収集開始」が出力されない**
   - タスクループが開始されていない
   - ボット再起動で解決する可能性

## 📊 監視コマンド

### リアルタイムログ監視
```bash
# 全ログ
tail -f C:\zeroone_support\bot.log

# メトリクス関連のみ
tail -f C:\zeroone_support\bot.log | findstr "メトリクス\|KPI\|DB"
```

### 定期データベース確認
```bash
# 10分おきにチェック
while true; do
  echo "=== $(date) ==="
  cd /mnt/c/find-to-do-management-app
  npx tsx scripts/check-discord-metrics.ts | head -20
  sleep 600
done
```

## ✅ 成功判定基準

### 短時間テスト
- [ ] 2分間隔でログが出力される
- [ ] エラーなくデータベース保存が完了する
- [ ] メッセージカウントがリセットされる

### 24時間テスト
- [ ] 24時間後に新しいデータが自動保存される
- [ ] ログに成功メッセージが出力される
- [ ] データの整合性が保たれている

## 🔧 トラブル時の対応

1. **即座に確認**: `/metrics_test` でDB接続テスト
2. **手動実行**: `/metrics` で手動収集テスト
3. **ログ確認**: bot.logで詳細エラー確認
4. **再起動**: 問題が続く場合はボット再起動

---
作成日: 2025-06-14
更新日: 自動保存確認後に更新予定